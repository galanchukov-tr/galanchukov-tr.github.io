<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интерактивный Журнал Профилактики</title>
    <!-- Подключение Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Настройка шрифта Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-theme-bg-color, #f4f7f9); /* Использование цвета темы TWA */
            color: var(--tg-theme-text-color, #1f2937);
        }
        .task-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #1f2937);
        }
        .completed {
            background-color: var(--tg-theme-hint-color, #ecfdf520); /* Slightly lighter completed */
            border-left: 4px solid #10b981; /* Emerald 500 */
        }
        .completed .task-name {
            text-decoration: line-through;
            color: var(--tg-theme-hint-color, #4b5563);
        }
        .nav-button {
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.06);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
        }
        /* Стили для формы логирования */
        .log-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--tg-theme-border-color, #d1d5db);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.15s, box-shadow 0.15s;
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #1f2937);
        }
        .log-input:focus {
            outline: none;
            border-color: var(--tg-theme-link-color, #4f46e5);
            box-shadow: 0 0 0 1px var(--tg-theme-link-color, #4f46e5);
        }
        .main-button-info {
            background-color: var(--tg-theme-secondary-bg-color, #e0f2f1);
        }
    </style>
</head>
<body>

<div class="min-h-screen p-4 sm:p-8 flex justify-center">
    <div class="w-full max-w-4xl bg-white shadow-xl rounded-xl p-6 sm:p-8" id="main-content-card">
        <!-- Заголовок -->
        <header class="mb-6 border-b pb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 flex items-center" style="color: var(--tg-theme-text-color);">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8 mr-3 text-indigo-600" style="color: var(--tg-theme-link-color);">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
                Журнал Обслуживания
            </h1>
            <p class="text-lg text-indigo-500 font-medium" id="current-location-display" style="color: var(--tg-theme-hint-color);">Главное меню</p>
            <p id="user-info" class="text-sm text-gray-500 mt-2" style="color: var(--tg-theme-hint-color);">ID Пользователя: Загрузка...</p>
        </header>

        <!-- Кнопка "Назад" (отображается только вне главного меню) -->
        <div id="backButtonContainer" class="mb-6 hidden">
            <button id="backButton" class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium py-2 px-3 rounded-lg bg-indigo-100 transition duration-150" style="color: var(--tg-theme-link-color); background-color: var(--tg-theme-secondary-bg-color);">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                </svg>
                Назад
            </button>
        </div>

        <!-- Контейнеры для различных представлений -->
        <div id="mainMenu" class="space-y-4">
            <!-- Кнопки главных разделов -->
        </div>

        <div id="locationList" class="hidden space-y-4">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="color: var(--tg-theme-text-color);">Выбор помещения</h2>
            <!-- Кнопки помещений будут здесь -->
        </div>

        <div id="taskList" class="hidden">
            <!-- Форма добавления новой задачи -->
            <div id="addTaskForm" class="mb-8 p-4 rounded-lg shadow-inner" style="background-color: var(--tg-theme-secondary-bg-color);">
                <h2 class="text-xl font-bold mb-3" style="color: var(--tg-theme-link-color);">Добавить новую задачу</h2>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="newTaskInput" placeholder="Введите название задачи по профилактике..."
                           class="flex-grow log-input shadow-sm">
                    
                    <!-- Этот элемент будет скрыт в TWA и показан как фолбэк -->
                    <button id="addTaskButton"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-[1.02] active:scale-[0.98]">
                        Добавить
                    </button>
                </div>
                <p id="twaMainButtonHint" class="mt-2 text-sm text-center font-medium text-gray-600 hidden" style="color: var(--tg-theme-hint-color);">
                    Для добавления используйте поле ввода и Главную кнопку Telegram внизу.
                </p>
            </div>

            <!-- Список задач -->
            <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="color: var(--tg-theme-text-color);">Журнал Работ</h2>
            <div id="taskListContainer" class="space-y-4">
                <p id="loadingMessage" class="text-center text-lg text-gray-500 p-8">Загрузка задач...</p>
                <!-- Задачи будут добавлены сюда в виде карточек -->
            </div>
        </div>


        <!-- Сообщения (для ошибок/уведомлений) -->
        <div id="messageBox" class="mt-6 p-3 rounded-lg text-sm hidden"></div>

    </div>
</div>

<!-- Скрипты Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, doc, addDoc, serverTimestamp, getDocs, updateDoc, writeBatch, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Установка уровня логирования для отладки
    setLogLevel('Debug');

    // --- DOM Элементы ---
    const mainMenu = document.getElementById('mainMenu');
    const locationList = document.getElementById('locationList');
    const taskList = document.getElementById('taskList');
    const taskListContainer = document.getElementById('taskListContainer');
    const loadingMessage = document.getElementById('loadingMessage');
    const newTaskInput = document.getElementById('newTaskInput');
    const addTaskButton = document.getElementById('addTaskButton');
    const twaMainButtonHint = document.getElementById('twaMainButtonHint');
    const messageBox = document.getElementById('messageBox');
    const userInfo = document.getElementById('user-info');
    const backButton = document.getElementById('backButton');
    const backButtonContainer = document.getElementById('backButtonContainer');
    const currentLocationDisplay = document.getElementById('current-location-display');
    const mainContentCard = document.getElementById('main-content-card');

    // --- Состояние приложения и TWA ---
    let db;
    let auth;
    let userId = 'loading';
    let currentView = 'mainMenu';
    let currentLocationGroup = null;
    let currentLocationId = null;
    let currentLocationName = 'Главное меню';
    let unsubscribe = null;
    let isTwa = false; // Флаг для определения, запущено ли приложение в TWA

    // --- Инициализация TWA ---
    if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
        isTwa = true;
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        
        // Применение цветов темы TWA к основному блоку
        mainContentCard.style.backgroundColor = 'var(--tg-theme-bg-color, #ffffff)';

        // Настройка Главной Кнопки
        Telegram.WebApp.MainButton.text = "ДОБАВИТЬ ЗАДАЧУ";
        Telegram.WebApp.MainButton.color = Telegram.WebApp.themeParams.button_color || '#4f46e5';
        Telegram.WebApp.MainButton.textColor = Telegram.WebApp.themeParams.button_text_color || '#ffffff';
        Telegram.WebApp.MainButton.onClick(handleMainButtonClick);
        Telegram.WebApp.MainButton.hide();

        // Скрытие внутренней кнопки и показ подсказки
        addTaskButton.classList.add('hidden');
        twaMainButtonHint.classList.remove('hidden');

        // Включаем нативную кнопку "Назад" в TWA
        Telegram.WebApp.onEvent('backButtonClicked', goBack);

        // Скрываем HTML кнопку "Назад" в TWA, т.к. используется нативная
        backButtonContainer.classList.add('hidden');
    }

    /**
     * Обработчик клика по Главной Кнопке Telegram
     */
    function handleMainButtonClick() {
        if (currentView === 'taskList') {
            const taskName = newTaskInput.value;
            addTask(taskName);
            if (isTwa) {
                Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
        }
    }

    // --- Глобальные переменные Canvas ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    if (!firebaseConfig.apiKey) {
        showMessage('Ошибка: Конфигурация Firebase не найдена. Сохранение данных невозможно.', 'bg-red-100 text-red-700');
        loadingMessage.textContent = 'Ошибка инициализации: нет конфигурации Firebase.';
        throw new Error("Firebase configuration not found.");
    }

    // 1. Конфигурация Локаций 
    const LOCATIONS_CONFIG = [
        { id: 'mo', name: 'МО', color: 'bg-indigo-600', hover: 'hover:bg-indigo-700', sublocations: [] },
        { id: 'lab', name: 'Лаборатория', color: 'bg-teal-600', hover: 'hover:bg-teal-700', sublocations: [] },
        { id: 'backoffice', name: 'Бэкофис', color: 'bg-orange-600', hover: 'hover:bg-orange-700', sublocations: [
            { id: 'back_accounting', name: 'Бухгалтерия', color: 'bg-orange-500', hover: 'hover:bg-orange-600' },
            { id: 'back_sales', name: 'Отдел продаж', color: 'bg-orange-500', hover: 'hover:bg-orange-600' }
        ]},
    ];

    const moGroup = LOCATIONS_CONFIG.find(g => g.id === 'mo');
    for (let i = 1; i <= 21; i++) {
        moGroup.sublocations.push({
            id: `mo_${i}`,
            name: `Кабинет №${i}`,
            color: 'bg-indigo-500',
            hover: 'hover:bg-indigo-600'
        });
    }

    const labGroup = LOCATIONS_CONFIG.find(g => g.id === 'lab');
    labGroup.sublocations.push({
        id: 'lab_main',
        name: 'Основное помещение',
        color: 'bg-teal-500',
        hover: 'hover:bg-teal-600'
    });
    
    const defaultTasks = [
        { name: "Профилактика ПК (Очистка временных файлов, дефрагментация)", category: "ПК" },
        { name: "Обновление ОС и драйверов", category: "ПК" },
        { name: "Проверка и обновление антивируса/системы безопасности", category: "ПК" },
        { name: "Физическая очистка системного блока/ноутбука от пыли", category: "ПК" },
        { name: "Проверка уровня чернил/тонера в принтере", category: "Оргтехника" },
        { name: "Очистка сканера/стекла копира", category: "Оргтехника" },
        { name: "Тестирование сетевого соединения и проверка кабелей", category: "Оргтехника" },
    ];


    // --- Утилиты для Даты ---

    function formatDateForInput(timestampOrDateString) {
        if (!timestampOrDateString) return '';
        let date;
        if (typeof timestampOrDateString === 'object' && timestampOrDateString.toDate) {
            date = timestampOrDateString.toDate();
        } else if (typeof timestampOrDateString === 'string') {
            date = new Date(timestampOrDateString);
        } else {
            return '';
        }
        
        if (isNaN(date) || date.getFullYear() < 1900) return '';
        
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // --- Инициализация Firebase и Аутентификация ---

    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);

    async function authenticateAndSetup() {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Ошибка аутентификации:", error);
            showMessage(`Ошибка аутентификации: ${error.message}`, 'bg-red-100 text-red-700');
        }
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            userId = user.uid;
            userInfo.textContent = `ID Пользователя: ${userId}`;
            renderView();
        } else {
            authenticateAndSetup();
        }
    });

    // --- Функции Навигации ---

    function navigateToLocationList(groupId) {
        currentLocationGroup = groupId;
        currentLocationId = null;
        currentLocationName = LOCATIONS_CONFIG.find(g => g.id === groupId).name;
        currentView = 'locationList';
        renderView();
    }

    function navigateToTaskList(locationId, locationName) {
        currentLocationId = locationId;
        currentLocationName = locationName;
        currentView = 'taskList';
        renderView();
        
        // При переходе в список задач включаем нативную кнопку "Назад" TWA
        if (isTwa) {
            Telegram.WebApp.BackButton.show();
        }
    }

    function goBack() {
        if (isTwa && currentView === 'mainMenu') {
            Telegram.WebApp.close();
            return;
        }

        if (currentView === 'taskList') {
            const group = LOCATIONS_CONFIG.find(g => g.sublocations.some(s => s.id === currentLocationId));
            if (group.id === 'lab' && group.sublocations.length === 1) {
                currentView = 'mainMenu';
                if (isTwa) Telegram.WebApp.BackButton.hide();
            } else {
                currentLocationId = null;
                currentLocationName = group.name;
                currentView = 'locationList';
            }
        } else if (currentView === 'locationList') {
            currentLocationGroup = null;
            currentLocationId = null;
            currentLocationName = 'Главное меню';
            currentView = 'mainMenu';
            if (isTwa) Telegram.WebApp.BackButton.hide();
        }
        renderView();
    }

    // --- Основной Рендеринг (Вид) ---

    function renderView() {
        mainMenu.classList.add('hidden');
        locationList.classList.add('hidden');
        taskList.classList.add('hidden');
        
        // Управление видимостью кнопки "Назад" (только для фолбэка HTML)
        if (!isTwa) {
            if (currentView === 'mainMenu') {
                backButtonContainer.classList.add('hidden');
            } else {
                backButtonContainer.classList.remove('hidden');
            }
        } else {
            // Управление видимостью Главной Кнопки TWA
            if (currentView === 'taskList') {
                Telegram.WebApp.MainButton.show();
                Telegram.WebApp.BackButton.show();
            } else if (currentView === 'locationList') {
                Telegram.WebApp.MainButton.hide();
                Telegram.WebApp.BackButton.show();
            } else { // mainMenu
                Telegram.WebApp.MainButton.hide();
                Telegram.WebApp.BackButton.hide();
            }
        }
        
        currentLocationDisplay.textContent = currentLocationName;

        if (unsubscribe) {
            unsubscribe();
            unsubscribe = null;
        }

        if (currentView === 'mainMenu') {
            renderMainMenu();
        } else if (currentView === 'locationList') {
            renderLocationList();
        } else if (currentView === 'taskList' && currentLocationId) {
            renderTaskListScreen();
        }
    }

    function renderMainMenu() {
        mainMenu.classList.remove('hidden');
        mainMenu.innerHTML = '';
        
        LOCATIONS_CONFIG.forEach(group => {
            const button = document.createElement('button');
            button.textContent = group.name;
            button.style.backgroundColor = group.color;
            button.className = `w-full text-left p-6 text-white font-bold text-xl rounded-lg nav-button ${group.hover} transition duration-200`;
            
            if (group.id === 'lab' && group.sublocations.length === 1) {
                button.addEventListener('click', () => navigateToTaskList(group.sublocations[0].id, group.sublocations[0].name));
            } else {
                button.addEventListener('click', () => navigateToLocationList(group.id));
            }
            mainMenu.appendChild(button);
        });
    }

    function renderLocationList() {
        locationList.classList.remove('hidden');
        locationList.innerHTML = `
            <h2 class="text-2xl font-bold mb-4 border-b pb-2" style="color: var(--tg-theme-text-color);">Выбор помещения: ${currentLocationName}</h2>
        `;
        const container = document.createElement('div');
        container.className = 'grid grid-cols-2 md:grid-cols-3 gap-4';
        locationList.appendChild(container);

        const group = LOCATIONS_CONFIG.find(g => g.id === currentLocationGroup);
        if (group) {
            group.sublocations.forEach(location => {
                const button = document.createElement('button');
                button.textContent = location.name;
                button.style.backgroundColor = location.color;
                button.className = `w-full text-center p-4 text-white font-semibold rounded-lg nav-button ${location.hover} transition duration-200`;
                button.addEventListener('click', () => navigateToTaskList(location.id, location.name));
                container.appendChild(button);
            });
        }
    }

    // --- Рендеринг Экрана Задач ---

    async function renderTaskListScreen() {
        taskList.classList.remove('hidden');
        loadingMessage.classList.remove('hidden');
        taskListContainer.innerHTML = ''; 

        const collectionPath = `artifacts/${appId}/users/${userId}/maintenance_journal`;
        const tasksRef = collection(db, collectionPath);

        await checkAndAddDefaultTasks(tasksRef, currentLocationId);

        // Используем сортировку по 'timestamp' для невыполненных задач и по 'completionDate' для выполненных в рендере
        const tasksQuery = query(tasksRef, where('locationId', '==', currentLocationId));

        unsubscribe = onSnapshot(tasksQuery, (snapshot) => {
            const tasks = [];
            snapshot.forEach(doc => {
                tasks.push({ id: doc.id, ...doc.data() });
            });
            renderTasks(tasks);
            loadingMessage.classList.add('hidden');
        }, (error) => {
            console.error("Ошибка при получении данных Firestore:", error);
            showMessage('Ошибка загрузки данных. Проверьте консоль.', 'bg-red-100 text-red-700');
            loadingMessage.textContent = 'Ошибка загрузки данных.';
        });
    }
    
    // --- Управление Задачами (CRUD & Defaults) ---

    async function checkAndAddDefaultTasks(tasksRef, locationId) {
        // ... (логика checkAndAddDefaultTasks без изменений)
        try {
            const existingTasksQuery = query(tasksRef, where('locationId', '==', locationId));
            const snapshot = await getDocs(existingTasksQuery);

            if (snapshot.empty) {
                const batch = writeBatch(db);

                defaultTasks.forEach((task) => {
                    const newDocRef = doc(tasksRef);
                    batch.set(newDocRef, {
                        name: task.name,
                        completed: false,
                        category: task.category,
                        locationId: locationId,
                        conditionNote: '',
                        completionDate: null, 
                        timestamp: serverTimestamp() || new Date(),
                    });
                });

                await batch.commit();
                showMessage(`Добавлены типовые задачи для ${currentLocationName}.`, 'bg-green-100 text-green-700');
            }
        } catch (error) {
            console.error("Ошибка при добавлении типовых задач:", error);
        }
    }
    
    async function addTask(name) {
        if (!userId || !currentLocationId) {
            showMessage('Сначала выберите помещение.', 'bg-yellow-100 text-yellow-700');
            return;
        }
        if (name.trim() === '') {
            showMessage('Пожалуйста, введите название задачи.', 'bg-yellow-100 text-yellow-700');
            return;
        }

        const taskData = {
            name: name.trim(),
            completed: false,
            category: 'Пользовательская',
            locationId: currentLocationId,
            conditionNote: '', 
            completionDate: null,
            timestamp: serverTimestamp() || new Date(),
        };

        try {
            const collectionPath = `artifacts/${appId}/users/${userId}/maintenance_journal`;
            await addDoc(collection(db, collectionPath), taskData);
            newTaskInput.value = '';
            // Скрываем MainButton после успешного добавления, если поле ввода пусто
            if (isTwa && newTaskInput.value === '') {
                 Telegram.WebApp.MainButton.hide();
            }
            showMessage('Задача успешно добавлена!', 'bg-green-100 text-green-700');
        } catch (error) {
            console.error("Ошибка при добавлении задачи:", error);
            showMessage('Ошибка при добавлении задачи. Проверьте консоль.', 'bg-red-100 text-red-700');
        }
    }
    
    async function updateTaskLog(taskId, isCompleted, dateString, conditionNote) {
        if (!userId) return;

        const docRef = doc(db, `artifacts/${appId}/users/${userId}/maintenance_journal`, taskId);
        const updateData = {
            completed: isCompleted,
            conditionNote: conditionNote.trim(),
            completionDate: isCompleted ? (dateString ? dateString : formatDateForInput(new Date())) : null,
        };

        if (!isCompleted) {
            updateData.conditionNote = '';
        }
        
        try {
            await updateDoc(docRef, updateData);
            showMessage('Журнал работ обновлен.', 'bg-blue-100 text-blue-700');
        } catch (error) {
            console.error("Ошибка при обновлении журнала:", error);
            showMessage('Ошибка сохранения данных. Проверьте консоль.', 'bg-red-100 text-red-700');
        }
    }

    async function deleteTask(taskId) {
        if (!userId) return;

        try {
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/maintenance_journal`, taskId);
            await deleteDoc(docRef);
            showMessage('Задача удалена.', 'bg-red-100 text-red-700');
        } catch (error) {
            console.error("Ошибка при удалении задачи:", error);
            showMessage('Ошибка при удалении задачи. Проверьте консоль.', 'bg-red-100 text-red-700');
        }
    }

    // --- Рендеринг UI Задач ---

    function renderTasks(tasks) {
        taskListContainer.innerHTML = '';
        if (tasks.length === 0) {
            taskListContainer.innerHTML = '<p class="text-center text-lg text-gray-500 p-8 border-2 border-dashed rounded-lg" style="color: var(--tg-theme-hint-color); border-color: var(--tg-theme-border-color);">Задач пока нет.</p>';
            return;
        }

        const sortedTasks = tasks.sort((a, b) => {
            if (a.completed === b.completed) {
                if (a.completed) {
                    const dateA = a.completionDate ? new Date(a.completionDate) : 0;
                    const dateB = b.completionDate ? new Date(b.completionDate) : 0;
                    return dateB - dateA;
                }
                return a.name.localeCompare(b.name);
            }
            return a.completed ? 1 : -1;
        });

        sortedTasks.forEach(task => {
            const taskId = task.id;
            const isCompleted = task.completed;
            const currentConditionNote = task.conditionNote || '';
            const currentDateValue = task.completionDate ? formatDateForInput(task.completionDate) : '';


            const taskDiv = document.createElement('div');
            taskDiv.id = `task-${taskId}`;
            taskDiv.className = `task-card p-4 sm:p-6 rounded-xl shadow-md ${isCompleted ? 'completed' : 'bg-white border-l-4 border-indigo-400 hover:shadow-lg'}`;
            taskDiv.style.borderColor = isCompleted ? '#10b981' : 'var(--tg-theme-link-color, #4f46e5)';

            // 1. Заголовок и кнопка удаления
            const header = document.createElement('div');
            header.className = 'flex items-start justify-between mb-4 pb-2 border-b border-gray-200';
            header.style.borderColor = 'var(--tg-theme-border-color)';
            
            const titleGroup = document.createElement('div');
            titleGroup.className = 'flex flex-col min-w-0 pr-4';

            const taskName = document.createElement('span');
            taskName.className = 'task-name text-base sm:text-lg font-bold break-words';
            taskName.textContent = task.name;

            const categoryTag = document.createElement('span');
            categoryTag.className = 'px-2 py-0.5 mt-1 text-xs font-semibold rounded-full w-fit';
            categoryTag.textContent = `Категория: ${task.category || 'Общее'}`;
            categoryTag.style.backgroundColor = 'var(--tg-theme-link-color, #4f46e5)';
            categoryTag.style.color = 'var(--tg-theme-button-text-color, #ffffff)';


            titleGroup.appendChild(taskName);
            titleGroup.appendChild(categoryTag);
            header.appendChild(titleGroup);

            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.58.275-2.314.542A3.375 3.375 0 0 0 3.25 5.25c0 .322.043.64.124.945.034.09.071.179.116.264l1.458 2.535-1.026 3.916a2.25 2.25 0 0 0 1.05 2.502 2.25 2.25 0 0 0 2.502-1.05l1.049-3.992 1.353 1.352c.273.273.651.41 1.028.41.377 0 .755-.137 1.028-.41L15 10.158l.732 2.196a2.25 2.25 0 0 0 2.502 1.05 2.25 2.25 0 0 0 1.05-2.502l-1.026-3.916 1.458-2.535c.045-.085.082-.174.116-.264a3.375 3.375 0 0 0 .124-.945c0-.38-.135-.747-.375-1.036a3.375 3.375 0 0 0-2.314-.542V3.75C13.25 2.515 12.235 1 11 1H8.75Zm5.402 4.498a.75.75 0 0 1 0 1.06L12.5 8.169l2.25 2.25a.75.75 0 1 1-1.06 1.06L11.44 9.23l-2.25 2.25a.75.75 0 0 1-1.06 0 .75.75 0 0 1 0-1.06l2.25-2.25-2.25-2.25a.75.75 0 0 1 1.06-1.06l2.25 2.25 2.25-2.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" /></svg>`;
            deleteButton.title = 'Удалить задачу';
            deleteButton.className = 'flex-shrink-0 bg-gray-200 hover:bg-red-500 text-gray-600 hover:text-white p-2 rounded-full transition duration-150 ease-in-out';
            deleteButton.addEventListener('click', () => deleteTask(taskId));
            header.appendChild(deleteButton);
            taskDiv.appendChild(header);


            // 2. Блок логирования (табличный вид)
            const logGrid = document.createElement('div');
            logGrid.className = 'grid grid-cols-1 sm:grid-cols-3 gap-3 items-center';

            // Столбец 1: Статус (Чекбокс)
            const statusCell = document.createElement('div');
            statusCell.className = 'flex items-center space-x-2 sm:col-span-1';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = isCompleted;
            checkbox.className = 'form-checkbox h-5 w-5 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer flex-shrink-0';
            checkbox.style.color = 'var(--tg-theme-link-color)';
            checkbox.style.borderColor = 'var(--tg-theme-border-color)';
            checkbox.style.backgroundColor = 'var(--tg-theme-secondary-bg-color)';
            
            const statusLabel = document.createElement('label');
            statusLabel.textContent = 'Выполнено';
            statusLabel.className = 'font-semibold';
            statusLabel.style.color = 'var(--tg-theme-text-color)';

            statusCell.appendChild(checkbox);
            statusCell.appendChild(statusLabel);

            // Столбец 2: Дата
            const dateCell = document.createElement('div');
            dateCell.className = 'sm:col-span-1';
            
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.value = currentDateValue;
            dateInput.title = 'Дата выполнения работ';
            dateInput.className = 'log-input';
            dateCell.appendChild(dateInput);

            // Столбец 3: Состояние
            const conditionCell = document.createElement('div');
            conditionCell.className = 'sm:col-span-1';
            
            const conditionInput = document.createElement('input');
            conditionInput.type = 'text';
            conditionInput.placeholder = 'Состояние ПК/Примечание';
            conditionInput.value = currentConditionNote;
            conditionInput.title = 'Описание состояния ПК или выполненных работ';
            conditionInput.className = 'log-input';
            conditionCell.appendChild(conditionInput);

            logGrid.appendChild(statusCell);
            logGrid.appendChild(dateCell);
            logGrid.appendChild(conditionCell);
            
            taskDiv.appendChild(logGrid);
            taskListContainer.appendChild(taskDiv);

            // --- Обработчики событий для полей логирования ---
            
            const saveLog = () => {
                const newCompletedStatus = checkbox.checked;
                const newDateValue = dateInput.value;
                const newConditionNote = conditionInput.value;
                updateTaskLog(taskId, newCompletedStatus, newDateValue, newConditionNote);

                // Добавляем тактильную обратную связь при сохранении
                if (isTwa) {
                    Telegram.WebApp.HapticFeedback.impactOccurred('soft');
                }
            };

            checkbox.addEventListener('change', () => {
                if (checkbox.checked && !dateInput.value) {
                    dateInput.value = formatDateForInput(new Date());
                }
                saveLog();
            });

            dateInput.addEventListener('blur', saveLog);
            conditionInput.addEventListener('blur', saveLog);

            conditionInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    conditionInput.blur(); 
                }
            });
        });
    }

    // --- Управление сообщениями и Обработчики событий ---

    let messageTimeout;
    function showMessage(text, className) {
        clearTimeout(messageTimeout);
        messageBox.textContent = text;
        messageBox.className = `mt-6 p-3 rounded-lg text-sm transition-all duration-300 ${className}`;
        messageBox.classList.remove('hidden');

        messageTimeout = setTimeout(() => {
            messageBox.classList.add('hidden');
        }, 3000);
    }
    
    // HTML-фолбэк кнопка "Назад"
    if (!isTwa) {
        backButton.addEventListener('click', goBack);
    }
    
    // HTML-фолбэк кнопка "Добавить"
    if (!isTwa) {
        addTaskButton.addEventListener('click', () => {
            addTask(newTaskInput.value);
        });
    }

    newTaskInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            // В TWA MainButton автоматически обработает ввод, если он виден
            if (isTwa && Telegram.WebApp.MainButton.isVisible) {
                handleMainButtonClick();
            } else {
                addTask(newTaskInput.value);
            }
        }
    });

    // --- Инициализация ---
    authenticateAndSetup();

</script>

</body>
</html>
